name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate tag/version/changelog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure crate versions match tag
        run: |
          python3 - <<'PY'
          import os, re, tomllib

          version = os.environ["GITHUB_REF_NAME"].removeprefix("v")
          if not re.fullmatch(r"\d+\.\d+\.\d+", version):
              raise SystemExit(f"Invalid tag version: {version}")

          crates = [
              ("mdstream", "mdstream/Cargo.toml"),
              ("mdstream-tokio", "mdstream-tokio/Cargo.toml"),
          ]

          for name, path in crates:
              with open(path, "rb") as f:
                  crate_version = tomllib.load(f)["package"]["version"]
              if crate_version != version:
                  raise SystemExit(
                      f"Tag v{version} does not match {name} version: {crate_version}"
                  )

          print(f"OK: v{version} matches all crate versions")
          PY

      - name: Ensure CHANGELOG.md contains version section
        run: |
          python3 - <<'PY'
          import os, re

          version = os.environ["GITHUB_REF_NAME"].removeprefix("v")
          with open("CHANGELOG.md", "r", encoding="utf-8") as f:
              text = f.read()

          patterns = [
              rf"^##\s+{re.escape(version)}\s*$",
              rf"^##\s+\[{re.escape(version)}\]\s*$",
          ]
          if not any(re.search(p, text, flags=re.MULTILINE) for p in patterns):
              raise SystemExit(f"CHANGELOG.md is missing a '## {version}' section")
          print(f"OK: CHANGELOG.md contains section for {version}")
          PY

  test:
    name: Test before publish
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy (all features)
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Test (no features)
        run: cargo test -p mdstream --tests && cargo test -p mdstream-tokio --tests

      - name: Test (all features)
        run: cargo test --workspace --all-features --tests

      - name: Check examples (no features)
        run: cargo check -p mdstream --examples

      - name: Check examples (pulldown)
        run: cargo check -p mdstream --features pulldown --examples

      - name: Check examples (mdstream-tokio)
        run: cargo check -p mdstream-tokio --examples

      - name: Cargo package
        run: |
          # `mdstream-tokio` depends on `mdstream = ^X.Y.Z`. During `cargo package`, Cargo resolves
          # deps as if publishing (path overrides are removed), so packaging `mdstream-tokio` would
          # fail until `mdstream` is already available on crates.io.
          #
          # `cargo publish -p mdstream-tokio` later will run packaging again after we publish
          # `mdstream` and wait for it to appear on crates.io.
          cargo package -p mdstream

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Publish
        run: |
          cargo publish -p mdstream --token "${{ secrets.CARGO_REGISTRY_TOKEN }}"
          python3 - <<'PY'
          import json
          import os
          import time
          import urllib.request

          version = os.environ["GITHUB_REF_NAME"].removeprefix("v")
          url = "https://crates.io/api/v1/crates/mdstream"

          for i in range(30):
              with urllib.request.urlopen(url) as resp:
                  data = json.load(resp)
              newest = data["crate"]["newest_version"]
              if newest == version:
                  print(f"OK: mdstream {version} is visible on crates.io")
                  break
              time.sleep(5)
          else:
              raise SystemExit(f"Timed out waiting for mdstream {version} to appear on crates.io")
          PY
          cargo publish -p mdstream-tokio --token "${{ secrets.CARGO_REGISTRY_TOKEN }}"

  github-release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract release notes
        id: notes
        uses: ffurrer2/extract-release-notes@v2

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: ${{ steps.notes.outputs.release_notes }}
