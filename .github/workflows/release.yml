name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate tag/version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Cargo.toml version matches tag
        run: |
          python3 - <<'PY'
          import os, re, tomllib

          version = os.environ["GITHUB_REF_NAME"].removeprefix("v")
          if not re.fullmatch(r"\d+\.\d+\.\d+", version):
              raise SystemExit(f"Invalid tag version: {version}")

          with open("Cargo.toml", "rb") as f:
              crate_version = tomllib.load(f)["package"]["version"]

          if crate_version != version:
              raise SystemExit(
                  f"Tag v{version} does not match Cargo.toml version: {crate_version}"
              )

          print(f"OK: v{version} matches Cargo.toml")
          PY

  test:
    name: Test before publish
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy (all features)
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Test (no features)
        run: cargo test --tests

      - name: Test (all features)
        run: cargo test --all-features --tests

      - name: Check examples (no features)
        run: cargo check --examples

      - name: Check examples (pulldown)
        run: cargo check --features pulldown --examples

      - name: Cargo package
        run: cargo package

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Publish
        run: cargo publish --token "${{ secrets.CARGO_REGISTRY_TOKEN }}"

  github-release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: write
    steps:
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
